<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台指期複利試算 (自選合約，自動最佳化)</title>
    <style>
        :root {
            --primary-color: #0056b3;
            --bg-light: #f4f7f9;
            --border-color: #dee2e6;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
        }
        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-light);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        h1, h2 {
            color: var(--primary-color);
            text-align: center;
        }

        /* Outer Toggle Section */
        .outer-toggle-header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.2em;
            font-weight: bold;
        }
        .outer-toggle-header:hover {
            background-color: #004494;
        }
        .toggle-icon {
            font-size: 1.5em;
            transition: transform 0.3s ease-in-out;
        }
        .outer-toggle-header.collapsed .toggle-icon {
            transform: rotate(-90deg); /* 箭頭朝下表示可展開 */
        }
        .outer-toggle-header.expanded .toggle-icon {
            transform: rotate(0deg); /* 箭頭朝上表示可收合 */
        }
        .outer-toggle-content {
            overflow: hidden;
            max-height: 1000px; /* 足夠大的預設值 */
            transition: max-height 0.5s ease-in-out, opacity 0.5s ease-in-out;
            opacity: 1;
            /* 修正 Mobile 佈局問題：預設隱藏時直接 display: none */
            display: flex; 
            flex-wrap: wrap;
            gap: 25px;
            margin-bottom: 25px;
            padding-bottom: 25px;
            border-bottom: 2px solid var(--border-color);
        }
        .outer-toggle-content.collapsed {
            max-height: 0;
            opacity: 0;
            padding-bottom: 0;
            margin-bottom: 0;
            border-bottom: none;
            display: none; /* 讓其完全不佔空間 */
        }
        /* End Outer Toggle Section */

        /* Inner Toggle for each input-block */
        .input-block {
            flex: 1 1 400px; /* 基礎寬度，允許成長 */
            border: 1px solid var(--border-color);
            padding: 0; /* 移除外層 padding，讓 h3 和內容區塊控制 */
            border-radius: 6px;
            background-color: #fafafa;
        }
        .input-block h3 {
            margin: 0; /* 移除預設 margin */
            border-bottom: 1px solid #ddd;
            padding: 15px 20px; /* 作為內層 toggle header 的 padding */
            color: #555;
            background-color: #e9ecef;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top-left-radius: 6px;
            border-top-right-radius: 6px;
            transition: background-color 0.2s;
        }
        .input-block h3:hover {
            background-color: #d8e0e7;
        }
        .input-block h3 .toggle-icon {
            font-size: 1.2em; /* 內層 toggle icon 稍小 */
            color: #666;
        }
        .input-block h3.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }
        .input-block h3.expanded .toggle-icon {
            transform: rotate(0deg);
        }
        .input-content {
            padding: 20px; /* 內容區塊的 padding */
            overflow: hidden;
            max-height: 500px; /* 內容區塊的預設最大高度 */
            transition: max-height 0.5s ease-in-out, opacity 0.5s ease-in-out;
            opacity: 1;
        }
        .input-content.collapsed {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
        }
        /* End Inner Toggle */

        .form-group {
            margin-bottom: 15px;
            display: flex;
            align-items: center; /* 垂直居中對齊 */
            justify-content: space-between;
        }
        .form-group label {
            flex: 2; /* 標籤佔用更多空間 */
            font-weight: 500;
            white-space: nowrap; /* 防止標籤換行 */
            margin-right: 10px;
        }
        .form-group input[type="number"],
        .form-group input[type="date"] {
            flex: 1; /* 輸入框佔用剩餘空間 */
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: right;
            font-size: 14px;
            min-width: 80px; /* 最小寬度 */
        }
        .sub-group {
            background: #f0f4f8;
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .sub-group-title {
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        /* Contract Selection */
        .contract-selection {
            background: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            text-align: center;
            display: flex; /* 使用 flex 佈局 */
            flex-wrap: wrap; /* 允許換行 */
            justify-content: center; /* 居中對齊 */
            gap: 15px; /* 項目間距 */
        }
        .contract-selection label {
            font-weight: bold;
            cursor: pointer;
            white-space: nowrap; /* 不換行 */
            display: inline-flex; /* 讓 label 和 input 並排，方便控制 */
            align-items: center;
        }
        .contract-selection label input[type="checkbox"] {
            margin-right: 5px;
        }
        /* Strategy Switcher */
        .strategy-switch {
            margin-bottom: 15px;
            text-align: center;
            padding: 10px;
            background: #e9ecef;
            border-radius: 4px;
        }
        .strategy-switch label {
            margin: 0 15px;
            cursor: pointer;
            font-weight: bold;
            white-space: nowrap;
        }
        .mode-inputs {
            display: none; /* Hidden by default */
            padding: 15px;
            background: #fff;
            border: 1px solid var(--primary-color);
            border-radius: 4px;
        }
        .mode-inputs.active {
            display: block;
        }
        /* Simulation Mode Switch */
        .simulation-mode-switch {
            text-align: center;
            margin-bottom: 20px;
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
        }
        .simulation-mode-switch label {
            margin: 0 10px;
            font-weight: bold;
            cursor: pointer;
            white-space: nowrap;
        }

        /* Button */
        .btn-block {
            text-align: center;
            margin: 25px 0;
        }
        button#calculateBtn {
            padding: 12px 40px;
            font-size: 18px;
            background-color: var(--success-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button#calculateBtn:hover {
            background-color: #218838;
        }
        /* Output Section */
        #resultSection {
            display: none;
        }
        .summary-box {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            font-size: 1.1em;
            border: 1px solid #c3e6cb;
            flex-wrap: wrap; /* 允許換行 */
            gap: 10px; /* 項目間距 */
        }
        .summary-item {
            flex: 1 1 auto; /* 允許項目自適應寬度 */
            min-width: 150px; /* 每個項目最小寬度 */
            text-align: center;
            padding: 5px; /* 為了兩欄顯示時有間距 */
        }
        .summary-item span {
            display: block;
            font-size: 1.5em;
            font-weight: bold;
        }
        /* Table Styles */
        .table-responsive {
            overflow-x: auto; /* 允許表格水平滾動 */
            -webkit-overflow-scrolling: touch; /* 改善 iOS 上的滾動體驗 */
        }
        table {
            width: 100%; /* 在大螢幕上盡量撐開 */
            min-width: 900px; /* 調整最小寬度以容納更多欄位 */
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        th, td {
            border: 1px solid var(--border-color);
            padding: 10px 8px;
            text-align: center;
        }
        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 500;
            white-space: nowrap; /* 標題不換行 */
        }
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        tr.night-session {
            background-color: #eef2f5;
        }
        .profit-positive {
            color: var(--success-color);
            font-weight: bold;
        }
        .profit-negative {
            color: var(--danger-color);
            font-weight: bold;
        }
        .final-capital-cell {
            font-weight: bold;
            background-color: #e8f5e9;
        }
        .best-contract {
            font-weight: bold;
            color: var(--primary-color);
        }
        .note {
            font-size: 0.9em;
            color: #666;
            margin-top: 10px;
        }

        /* RWD Styles for smaller screens */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 15px;
            }
            h1 {
                font-size: 1.6em;
            }
            h2 {
                font-size: 1.3em;
            }
            .outer-toggle-header {
                font-size: 1.1em;
                padding: 12px 15px;
            }
            .toggle-icon {
                font-size: 1.3em;
            }

            .outer-toggle-content {
                flex-direction: column; /* 輸入區塊垂直堆疊 */
                gap: 15px;
            }
            .input-block {
                flex: 1 1 100%; /* 每個輸入區塊佔滿寬度 */
                /* 內層 padding 由 .input-content 控制 */
            }
            .input-block h3 {
                padding: 12px 15px;
                font-size: 1em;
            }

            /* 需求1: label 在左上，input 欄位在右下，input 只有底線 */
            .form-group {
                flex-direction: column; /* 垂直堆疊 */
                align-items: flex-start; /* 左上對齊 */
            }
            .form-group label {
                width: 100%; /* 標籤佔滿一行 */
                margin-bottom: 5px; /* 與 input 之間的間距 */
                margin-right: 0; /* 移除右邊距 */
                font-size: 13px; /* 縮小字體 */
            }
            .form-group input[type="number"],
            .form-group input[type="date"] {
                width: 100%; /* 輸入框佔滿一行 */
                border: none; /* 移除所有邊框 */
                border-bottom: 1px solid #ccc; /* 只留底部邊框 */
                background-color: transparent; /* 背景透明 */
                padding: 6px 0; /* 調整內距，靠底部邊框 */
                text-align: left; /* 文字靠左顯示 */
                font-size: 14px; /* 輸入框字體大小 */
            }
            /* End 需求1 */

            /* 需求2: 合約選擇文字大小與排版 */
            .contract-selection {
                gap: 10px; /* 縮小項目間距 */
            }
            .contract-selection label {
                font-size: 13px; /* 縮小字體 */
                margin: 0; /* 移除多餘間距 */
            }
            /* End 需求2 */

            .strategy-switch label, .simulation-mode-switch label {
                font-size: 13px;
                margin: 0 8px; /* 縮小間距 */
            }
            .mode-inputs .note {
                font-size: 0.8em;
            }

            /* 需求3: 結果報告在mobile是兩欄一個row */
            .summary-box {
                flex-direction: row; /* 改回水平排佈 */
                flex-wrap: wrap; /* 允許換行 */
                justify-content: space-between; /* 兩端對齊，項目間有彈性空間 */
                gap: 10px; /* 項目間距 */
            }
            .summary-item {
                flex: 0 0 calc(50% - 10px); /* 兩欄佈局，考慮 gap 空間 */
                padding: 5px;
                font-size: 0.9em; /* 縮小字體 */
                text-align: center; /* 讓內容居中，視覺上更平衡 */
            }
            /* 移除之前針對單數偶數的對齊，讓其統一居中 */
            .summary-item:nth-child(odd), .summary-item:nth-child(even) { 
                text-align: center;
            }
            .summary-item span {
                font-size: 1.1em; /* 縮小字體 */
            }
            /* End 需求3 */

            table {
                font-size: 11px; /* 表格字體更小 */
                min-width: unset; /* 取消最小寬度，讓 table-responsive 負責滾動 */
            }
            th, td {
                padding: 6px 4px; /* 表格內距縮小 */
                white-space: nowrap; /* 確保內容不換行，讓滾動有效 */
            }
        }
        /* For very small screens to ensure strategy radio buttons fit */
        @media (max-width: 480px) {
            .strategy-switch label, .simulation-mode-switch label {
                display: block; /* 每個選項獨立一行 */
                margin-bottom: 5px;
            }
            .contract-selection {
                flex-direction: column; /* 超小螢幕時合約選擇也垂直堆疊 */
                gap: 5px;
            }
            .contract-selection label {
                justify-content: flex-start; /* 左對齊 */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>台指期複利試算 (自選合約，自動最佳化)</h1>

        <div id="outerToggleHeader" class="outer-toggle-header collapsed">
            條件設定 <span class="toggle-icon">▼</span>
        </div>

        <div id="outerToggleContent" class="outer-toggle-content collapsed">
            <div class="input-block">
                <h3 class="inner-toggle-header collapsed">
                    1. 資金與成本設定 <span class="toggle-icon">▼</span>
                </h3>
                <div class="input-content collapsed">
                    <div class="form-group">
                        <label for="initialCapital">初始本金 (NT$):</label>
                        <input type="number" id="initialCapital" value="56000" min="0" step="1000">
                    </div>
                    <div class="form-group" style="background: #fff3cd; padding: 5px;">
                        <label for="assumedIndex">假設指數點位 (計算期交稅用):</label>
                        <input type="number" id="assumedIndex" value="27740" min="0" step="100">
                    </div>
                    <p class="note">*期交稅率以十萬分之2計算，不足一元以一元計收。</p>
                    
                    <div class="sub-group">
                        <div class="sub-group-title">【台指期 (大台) - 每點$200】</div>
                        <div class="form-group">
                            <label for="bigMargin">原始保證金:</label>
                            <input type="number" id="bigMargin" value="338000" min="0"> </div>
                        <div class="form-group">
                            <label for="bigComm">來回手續費 (總計):</label>
                            <input type="number" id="bigComm" value="80" min="0">
                        </div>
                    </div>

                    <div class="sub-group">
                        <div class="sub-group-title">【小型台指 (小台) - 每點$50】</div>
                        <div class="form-group">
                            <label for="miniMargin">原始保證金:</label>
                            <input type="number" id="miniMargin" value="84500" min="0"> </div>
                        <div class="form-group">
                            <label for="miniComm">來回手續費 (總計):</label>
                            <input type="number" id="miniComm" value="40" min="0">
                        </div>
                    </div>

                    <div class="sub-group">
                        <div class="sub-group-title">【微型台指 (微台) - 每點$10】</div>
                        <div class="form-group">
                            <label for="microMargin">原始保證金:</label>
                            <input type="number" id="microMargin" value="16900" min="0"> </div>
                        <div class="form-group">
                            <label for="microComm">來回手續費 (總計):</label>
                            <input type="number" id="microComm" value="36" min="0">
                        </div>
                    </div>
                </div></div><div class="input-block">
                <h3 class="inner-toggle-header collapsed">
                    2. 交易合約選擇 <span class="toggle-icon">▼</span>
                </h3>
                <div class="input-content collapsed">
                    <div class="contract-selection">
                        <label>
                            <input type="checkbox" id="selectBig" checked> 大台
                        </label>
                        <label>
                            <input type="checkbox" id="selectMini" checked> 小台
                        </label>
                        <label>
                            <input type="checkbox" id="selectMicro" checked> 微台
                        </label>
                        <p class="note">*至少選擇一個合約進行試算。</p>
                    </div>
                </div></div><div class="input-block">
                <h3 class="inner-toggle-header collapsed">
                    3. 獲利目標策略 (二選一) <span class="toggle-icon">▼</span>
                </h3>
                <div class="input-content collapsed">
                    <div class="strategy-switch">
                        <label>
                            <input type="radio" name="strategyMode" value="A" onchange="toggleMode()"> 模式 A: 設定「每盤總目標點數」
                        </label>
                        <label>
                            <input type="radio" name="strategyMode" value="B" checked onchange="toggleMode()"> 模式 B: 設定「單次獲利 x 次數」
                        </label>
                    </div>

                    <div id="modeAInputs" class="mode-inputs">
                        <p class="note">說明：直接設定早盤/夜盤預計達到的總淨點數。系統預設每盤僅進出「1趟」來計算成本。</p>
                        <div class="form-group">
                            <label for="modeA_morningPoints">早盤目標總點數:</label>
                            <input type="number" id="modeA_morningPoints" value="200" min="0">
                        </div>
                        <div class="form-group">
                            <label for="modeA_nightPoints">夜盤目標總點數:</label>
                            <input type="number" id="modeA_nightPoints" value="150" min="0">
                        </div>
                    </div>

                    <div id="modeBInputs" class="mode-inputs active">
                        <p class="note">說明：設定單筆交易獲利點數，以及早/夜盤各交易幾趟。成本會隨交易次數增加。</p>
                        <div class="form-group">
                            <label for="modeB_pointsPerTrade">單次交易目標點數:</label>
                            <input type="number" id="modeB_pointsPerTrade" value="70" min="0">
                        </div>
                        <div class="form-group">
                            <label for="modeB_morningTrades">早盤交易次數 (趟):</label>
                            <input type="number" id="modeB_morningTrades" value="3" min="0">
                        </div>
                        <div class="form-group">
                            <label for="modeB_nightTrades">夜盤交易次數 (趟):</label>
                            <input type="number" id="modeB_nightTrades" value="2" min="0">
                        </div>
                    </div>
                </div></div></div><div class="simulation-mode-switch">
            <label>
                <input type="radio" name="simulationMode" value="20days" checked onchange="toggleSimulationMode()"> 20日複利試算
            </label>
            <label>
                <input type="radio" name="simulationMode" value="3days" onchange="toggleSimulationMode()"> 3日損益預估
            </label>
            <div id="startDateGroup" class="form-group" style="display: none; margin-top: 15px; background: #f0f4f8; padding: 10px; border-radius: 4px;">
                <label for="startDate">起始交易日:</label>
                <input type="date" id="startDate">
            </div>
        </div>

        <div class="btn-block">
            <button id="calculateBtn" onclick="startSimulation()">開始試算</button>
        </div>

        <div id="resultSection">
            <h2 id="resultTitle">試算結果報告</h2>
            <div class="summary-box">
                <div class="summary-item">初始本金: <span id="summaryInitial"></span></div>
                <div class="summary-item">20日後本金: <span id="summaryFinal"></span></div>
                <div class="summary-item">總獲利金額: <span id="summaryProfit"></span></div>
                <div class="summary-item">總報酬率: <span id="summaryROI"></span></div>
            </div>

            <div class="table-responsive">
                <table id="resultTable">
                    <thead>
                        <tr>
                            <th id="dayHeader">天數</th>
                            <th>盤別</th>
                            <th>期初本金</th>
                            <th>最佳建議</th>
                            <th>下單口數</th>
                            <th>目標點數<br>(總計)</th>
                            <th>預估總稅金<br>(買+賣)</th>
                            <th>總手續費<br>(買+賣)</th>
                            <th>本盤淨利</th>
                            <th>期末本金</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
            <p class="note">*註1：「最佳建議」為系統自動計算當下資金全下您選擇的合約中，何者淨利較高。</p>
            <p class="note">*註2：期交稅計算方式為「合約價值 * 0.00002」，採無條件進位，買賣雙邊收取。</p>
            <p class="note">*註3：此試算假設每次交易皆達成目標點數，未考慮虧損風險，僅供策略規劃參考，實際交易請審慎評估。</p>
        </div>
    </div>

    <script>
        // 常數定義
        const TAX_RATE = 0.00002;
        const BIG_POINT_VALUE = 200; // 大台一點 $200
        const MINI_POINT_VALUE = 50; // 小台一點 $50
        const MICRO_POINT_VALUE = 10; // 微台一點 $10

        // 初始化日期選擇器為今天，並初始化所有 Toggle 狀態
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            document.getElementById('startDate').value = `${year}-${month}-${day}`;
            
            // 初始狀態：預設模式B，所以需要手動呼叫一次toggleMode
            toggleMode();
            // 初始狀態：預設20日試算模式
            toggleSimulationMode(); 

            // 初始化所有內層 toggle 為 collapsed 狀態
            document.querySelectorAll('.input-block h3').forEach(header => {
                header.classList.add('collapsed');
                header.nextElementSibling.classList.add('collapsed'); // input-content
            });
            // 外層 toggle 預設也是 collapsed 狀態，已在HTML中設置
        });

        // 外層 Toggle 功能
        document.getElementById('outerToggleHeader').addEventListener('click', function() {
            const outerContent = document.getElementById('outerToggleContent');
            this.classList.toggle('collapsed');
            this.classList.toggle('expanded');
            outerContent.classList.toggle('collapsed');
            // 如果從 collapsed 變為 expanded，需要重新調整 display 屬性以允許 flex 佈局
            if (!outerContent.classList.contains('collapsed')) {
                outerContent.style.display = 'flex';
            } else {
                // 為了讓 transition 執行完畢，可以稍微延遲再設為 none
                setTimeout(() => {
                    outerContent.style.display = 'none';
                }, 500); // 與 transition-duration 保持一致
            }
        });

// 內層 Toggle 功能 (為每個 input-block 的 h3 綁定事件)
        document.querySelectorAll('.input-block h3').forEach(header => {
            header.addEventListener('click', function() {
                const content = this.nextElementSibling; // input-content div
                this.classList.toggle('collapsed');
                this.classList.toggle('expanded');
                content.classList.toggle('collapsed');
            });
        });

        // 切換獲利目標模式 (A或B)
        function toggleMode() {
            const mode = document.querySelector('input[name="strategyMode"]:checked').value;
            document.getElementById('modeAInputs').classList.toggle('active', mode === 'A');
            document.getElementById('modeBInputs').classList.toggle('active', mode === 'B');
        }

        // 切換試算模式 (20日複利 vs 3日預估)
        function toggleSimulationMode() {
            const simulationMode = document.querySelector('input[name="simulationMode"]:checked').value;
            const startDateGroup = document.getElementById('startDateGroup');
            const dayHeader = document.getElementById('dayHeader');
            const resultTitle = document.getElementById('resultTitle');
            const summaryFinalItem = document.getElementById('summaryFinal').closest('.summary-item'); // 獲取父級 .summary-item
            const summaryROIItem = document.getElementById('summaryROI').closest('.summary-item'); // 獲取父級 .summary-item
            
            // 更新表格標題
            document.querySelector('#resultTable thead tr').innerHTML = `
                <th id="dayHeader">${simulationMode === '3days' ? '日期' : '天數'}</th>
                <th>盤別</th>
                <th>期初本金</th>
                <th>最佳建議</th>
                <th>下單口數</th>
                <th>目標點數<br>(總計)</th>
                <th>預估總稅金<br>(買+賣)</th>
                <th>總手續費<br>(買+賣)</th>
                <th>本盤淨利</th>
                <th>期末本金</th>
            `;

            if (simulationMode === '3days') {
                startDateGroup.style.display = 'flex';
                resultTitle.innerText = '未來3日損益預估';
                summaryFinalItem.style.display = 'none';
                summaryROIItem.style.display = 'none';
            } else {
                startDateGroup.style.display = 'none';
                resultTitle.innerText = '試算結果報告';
                summaryFinalItem.style.display = 'block';
                summaryROIItem.style.display = 'block';
            }
        }

        // 格式化數字為貨幣字串 (例如 123,456)
        function formatCurrency(num) {
            return new Intl.NumberFormat('zh-TW', { maximumFractionDigits: 0 }).format(num);
        }
        
        // 計算單邊稅金 (無條件進位 Math.ceil)
        function calculateSingleSideTax(index, pointValue) {
            // 稅金 = 指數 * 點值 * 稅率，結果無條件進位
            return Math.ceil(index * pointValue * TAX_RATE);
        }

        // 判斷是否為交易日 (週一到週五)
        function isTradingDay(date) {
            const dayOfWeek = date.getDay(); // 0 = 星期日, 1 = 星期一, ..., 6 = 星期六
            return dayOfWeek >= 1 && dayOfWeek <= 5;
        }

        // 獲取下一個交易日
        function getNextTradingDay(currentDate) {
            const nextDay = new Date(currentDate);
            nextDay.setDate(currentDate.getDate() + 1); // 先加一天
            while (!isTradingDay(nextDay)) {
                nextDay.setDate(nextDay.getDate() + 1); // 如果是週末，繼續加一天
            }
            return nextDay;
        }

        // 核心試算函數
        function startSimulation() {
            // 1. 獲取輸入值
            const initialCapital = parseFloat(document.getElementById('initialCapital').value) || 0;
            const assumedIndex = parseFloat(document.getElementById('assumedIndex').value) || 27740; // 預設值已更新
            
            // 合約選擇狀態
            const selectBig = document.getElementById('selectBig').checked;
            const selectMini = document.getElementById('selectMini').checked;
            const selectMicro = document.getElementById('selectMicro').checked;

            if (!selectBig && !selectMini && !selectMicro) {
                alert("請至少選擇一個交易合約進行試算！");
                return;
            }

            // 大台參數
            const bigMargin = parseFloat(document.getElementById('bigMargin').value) || 0;
            const bigComm = parseFloat(document.getElementById('bigComm').value) || 0;
            // 小台參數
            const miniMargin = parseFloat(document.getElementById('miniMargin').value) || 0;
            const miniComm = parseFloat(document.getElementById('miniComm').value) || 0;
            // 微台參數
            const microMargin = parseFloat(document.getElementById('microMargin').value) || 0;
            const microComm = parseFloat(document.getElementById('microComm').value) || 0;

            const mode = document.querySelector('input[name="strategyMode"]:checked').value;
            let morningPointsTarget, nightPointsTarget, morningTradesCount, nightTradesCount;

            if (mode === 'A') {
                morningPointsTarget = parseFloat(document.getElementById('modeA_morningPoints').value) || 0;
                nightPointsTarget = parseFloat(document.getElementById('modeA_nightPoints').value) || 0;
                morningTradesCount = 1; // 模式A預設進出1趟
                nightTradesCount = 1;
            } else { // 模式B為預設
                const pointsPerTrade = parseFloat(document.getElementById('modeB_pointsPerTrade').value) || 0;
                morningTradesCount = parseFloat(document.getElementById('modeB_morningTrades').value) || 0;
                nightTradesCount = parseFloat(document.getElementById('modeB_nightTrades').value) || 0;
                morningPointsTarget = pointsPerTrade * morningTradesCount;
                nightPointsTarget = pointsPerTrade * nightTradesCount;
            }

            // 基本驗證
            if (initialCapital <= 0) {
                alert("請輸入正確的初始本金數值");
                return;
            }
            if ((selectBig && bigMargin <= 0) || (selectMini && miniMargin <= 0) || (selectMicro && microMargin <= 0)) {
                alert("請檢查所選合約的保證金是否正確輸入 (不能為零)。");
                return;
            }

            let currentCapital = initialCapital;
            let tableBodyHTML = '';
            
            const simulationMode = document.querySelector('input[name="simulationMode"]:checked').value;
            let totalDaysToSimulate = 0;
            let currentSimulationDate = null;
            let dayLabels = []; // 用於3日預估顯示日期標籤

            if (simulationMode === '20days') {
                totalDaysToSimulate = 20;
            } else { // '3days' mode
                totalDaysToSimulate = 3;
                const startDateStr = document.getElementById('startDate').value;
                if (!startDateStr) {
                    alert("請選擇起始交易日期！");
                    return;
                }
                currentSimulationDate = new Date(startDateStr + 'T00:00:00'); // 避免時區問題
                
                // 找到第一個交易日
                while (!isTradingDay(currentSimulationDate)) {
                    currentSimulationDate.setDate(currentSimulationDate.getDate() + 1);
                }

                // 準備 3 日的日期標籤
                dayLabels = ['今日', '明日', '後天'];
            }

            // 2. 執行迴圈 (20 天或 3 交易日)
            for (let dayCounter = 1; dayCounter <= totalDaysToSimulate; dayCounter++) {
                let displayDayLabel = '';
                if (simulationMode === '20days') {
                    displayDayLabel = `D${dayCounter}`;
                } else { // '3days' mode
                    displayDayLabel = `${dayLabels[dayCounter - 1]} (${currentSimulationDate.getMonth() + 1}/${currentSimulationDate.getDate()})`;
                }

                // --- 早盤 ---
                currentCapital = runSessionSimulation(displayDayLabel, '早盤', currentCapital, assumedIndex, 
                                            selectBig ? { margin: bigMargin, comm: bigComm, pointValue: BIG_POINT_VALUE, name: '大台' } : null,
                                            selectMini ? { margin: miniMargin, comm: miniComm, pointValue: MINI_POINT_VALUE, name: '小台' } : null,
                                            selectMicro ? { margin: microMargin, comm: microComm, pointValue: MICRO_POINT_VALUE, name: '微台' } : null,
                                            morningPointsTarget, morningTradesCount);
                
                // --- 夜盤 ---
                currentCapital = runSessionSimulation(displayDayLabel, '夜盤', currentCapital, assumedIndex, 
                                            selectBig ? { margin: bigMargin, comm: bigComm, pointValue: BIG_POINT_VALUE, name: '大台' } : null,
                                            selectMini ? { margin: miniMargin, comm: miniComm, pointValue: MINI_POINT_VALUE, name: '小台' } : null,
                                            selectMicro ? { margin: microMargin, comm: microComm, pointValue: MICRO_POINT_VALUE, name: '微台' } : null,
                                            nightPointsTarget, nightTradesCount);

                // 3日預估模式需要推進到下一個交易日
                if (simulationMode === '3days' && dayCounter < totalDaysToSimulate) {
                    currentSimulationDate = getNextTradingDay(currentSimulationDate);
                }
            }

            // 3. 更新摘要報告
            const totalProfit = currentCapital - initialCapital;
            const roi = (totalProfit / initialCapital) * 100;

            document.getElementById('summaryInitial').innerText = '$' + formatCurrency(initialCapital);
            document.getElementById('summaryFinal').innerText = '$' + formatCurrency(currentCapital);
            document.getElementById('summaryProfit').innerText = (totalProfit >= 0 ? '+' : '') + '$' + formatCurrency(totalProfit);
            document.getElementById('summaryProfit').style.color = totalProfit >= 0 ? 'var(--success-color)' : 'var(--danger-color)';
            document.getElementById('summaryROI').innerText = roi.toFixed(2) + '%';

            document.getElementById('resultTable').getElementsByTagName('tbody')[0].innerHTML = tableBodyHTML;
            document.getElementById('resultSection').style.display = 'block';

            // 輔助函數：執行單一盤別試算並產生表格列 (接收合約物件，而非單獨參數)
            function runSessionSimulation(dayLabel, sessionName, startCap, index, 
                                          bigContract, miniContract, microContract, // 傳入合約物件或 null
                                          targetPoints, tradesCount) {
                if (targetPoints === 0 || tradesCount === 0) {
                     // 如果該盤沒有目標，直接回傳原本身金，並產生空資料列
                     generateTableRow(dayLabel, sessionName, startCap, '-', 0, 0, 0, 0, 0, startCap);
                     return startCap;
                }

                let bestContractName = '資金不足';
                let finalContracts = 0;
                let finalTax = 0;
                let finalComm = 0;
                let finalNetProfit = -Infinity; // 用負無限大確保能選出第一個可下單的

                const contractsToEvaluate = [];
                if (bigContract) contractsToEvaluate.push(bigContract);
                if (miniContract) contractsToEvaluate.push(miniContract);
                if (microContract) contractsToEvaluate.push(microContract);

                // 檢查是否有任何合約可以下單
                const canTradeAnyContract = contractsToEvaluate.some(c => Math.floor(startCap / c.margin) > 0);

                if (!canTradeAnyContract) {
                    bestContractName = '資金不足';
                    finalNetProfit = 0;
                } else {
                    for (const contract of contractsToEvaluate) {
                        const currentContracts = Math.floor(startCap / contract.margin);
                        if (currentContracts > 0) { // 只有能下單的合約才進行評估
                            const grossProfit = currentContracts * targetPoints * contract.pointValue;
                            const totalComm = currentContracts * contract.comm * tradesCount;
                            const singleSideTax = calculateSingleSideTax(index, contract.pointValue);
                            const totalTax = singleSideTax * 2 * currentContracts * tradesCount;
                            const netProfit = grossProfit - totalComm - totalTax;

                            if (netProfit > finalNetProfit) { // 選擇淨利更高的
                                finalNetProfit = netProfit;
                                bestContractName = contract.name;
                                finalContracts = currentContracts;
                                finalTax = totalTax;
                                finalComm = totalComm;
                            }
                        }
                    }

                    // 如果所有選中的合約計算後都導致虧損，則視為放棄交易，淨利為0
                    // 只有當至少有一個合約可以下單（即 currentContracts > 0）時，才考慮放棄
                    if (finalNetProfit <= 0 && contractsToEvaluate.some(c => Math.floor(startCap / c.margin) > 0)) {
                        bestContractName = '放棄交易(虧損)';
                        finalContracts = 0;
                        finalTax = 0;
                        finalComm = 0;
                        finalNetProfit = 0;
                    }
                }
                
                const endCap = startCap + finalNetProfit;

                // 產生表格 HTML
                generateTableRow(dayLabel, sessionName, startCap, bestContractName, finalContracts, targetPoints, finalTax, finalComm, finalNetProfit, endCap);

                return endCap; // 回傳期末本金供下一盤使用
            }

            function generateTableRow(dayLabel, sessionName, startCap, best, contracts, points, tax, comm, netProfit, endCap) {
                const rowClass = sessionName === '夜盤' ? 'night-session' : '';
                const profitClass = netProfit > 0 ? 'profit-positive' : (netProfit < 0 ? 'profit-negative' : '');
                
                tableBodyHTML += `
                    <tr class="${rowClass}">
                        <td>${dayLabel}</td>
                        <td>${sessionName}</td>
                        <td>${formatCurrency(startCap)}</td>
                        <td class="best-contract">${best}</td>
                        <td>${contracts} 口</td>
                        <td>${points} 點</td>
                        <td>$${formatCurrency(tax)}</td>
                        <td>$${formatCurrency(comm)}</td>
                        <td class="${profitClass}">$${formatCurrency(netProfit)}</td>
                        <td class="final-capital-cell">$${formatCurrency(endCap)}</td>
                    </tr>
                `;
            }
        }
    </script>
</body>
</html>